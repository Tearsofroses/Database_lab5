% ==========================================
\section{Trigger (e) - Salary Log}
% ==========================================

\textbf{Exercise:} Write the trigger(s) to maintain a log table containing information about the changes of employees' salaries.

\textbf{Log table structure:} (User, Date, ESSN, Old\_Salary, New\_Salary)

\textbf{Solution:}

\begin{lstlisting}
-- Create the log table if it doesn't exist
DROP TABLE IF EXISTS SALARY_LOG;
CREATE TABLE SALARY_LOG (
    Log_ID INT AUTO_INCREMENT PRIMARY KEY,
    User_Name VARCHAR(100),
    Change_Date DATETIME,
    ESSN CHAR(9),
    Old_Salary DECIMAL(10, 2),
    New_Salary DECIMAL(10, 2)
);

-- Trigger for INSERT: Log initial salary when employee is created
DROP TRIGGER IF EXISTS trg_log_salary_insert;
DELIMITER //
CREATE TRIGGER trg_log_salary_insert
AFTER INSERT ON EMPLOYEE
FOR EACH ROW
BEGIN
    INSERT INTO SALARY_LOG (User_Name, Change_Date, ESSN, Old_Salary, New_Salary)
    VALUES (CURRENT_USER(), NOW(), NEW.Ssn, NULL, NEW.Salary);
END //
DELIMITER ;

-- Trigger for UPDATE: Log salary changes
DROP TRIGGER IF EXISTS trg_log_salary_update;
DELIMITER //
CREATE TRIGGER trg_log_salary_update
AFTER UPDATE ON EMPLOYEE
FOR EACH ROW
BEGIN
    IF OLD.Salary != NEW.Salary THEN
        INSERT INTO SALARY_LOG (User_Name, Change_Date, ESSN, Old_Salary, New_Salary)
        VALUES (CURRENT_USER(), NOW(), NEW.Ssn, OLD.Salary, NEW.Salary);
    END IF;
END //
DELIMITER ;
\end{lstlisting}

\subsubsection*{Test Validation}
\begin{lstlisting}
-- Test INSERT: Add new employee
INSERT INTO EMPLOYEE VALUES ('New', 'N', 'Employee', '999999999', '1990-01-01', 
                             '123 St', 'M', 28000, '333445555', 5);

-- Check the log
SELECT * FROM SALARY_LOG WHERE ESSN = '999999999';
\end{lstlisting}

\textbf{Expected Output:}
\begin{center}
\includegraphics[width=0.95\textwidth]{Images/ex1/triggers/te1.png}
\end{center}

\begin{lstlisting}
-- Test UPDATE: Change salary
UPDATE EMPLOYEE SET Salary = 30000 WHERE Ssn = '999999999';
SELECT * FROM SALARY_LOG WHERE ESSN = '999999999';
\end{lstlisting}

\textbf{Expected Output:}
\begin{center}
\includegraphics[width=0.95\textwidth]{Images/ex1/triggers/te2.png}
\end{center}

